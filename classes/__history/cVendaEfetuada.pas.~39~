unit cVendaEfetuada;

interface

uses
  System.Classes, Vcl.Controls, Vcl.ExtCtrls, Vcl.Dialogs, System.SysUtils,
  datamodule, Data.DB, cCliente;

type
  TcVendaEfetuada = class
  private
    FId: Integer;
    FIdProduto: Integer;
    FQuantidade: Integer;
    FValorTotalCompra: Double;
    FCpfCliente: string;

  public
    property Id: Integer read FId write FId;
    property IdProduto: Integer read FIdProduto write FIdProduto;
    property Quantidade: Integer read FQuantidade write FQuantidade;
    property PrecoTotalCompra: Double read FValorTotalCompra write FValorTotalCompra;
    property cpfCliente: string read FCpfCliente write FCpfCliente;

    procedure RegistrarVenda(idProduto: integer; quantidade: integer; valorTotalCompra: double; cpfCliente: string);

  end;

implementation

procedure TcVendaEfetuada.RegistrarVenda
  (idProduto: integer; quantidade: integer; valorTotalCompra: double; cpfCliente: string);
var
  cCliente: TcCliente;
begin
  cCliente := TcCliente.Create;
  try
    with uDataModule.qryCarrinho do
      begin
        SQL.Text :=
        'SELECT c.id_produto, c.quantidade, c.preco_total ' +
        'FROM carrinho_venda c ' +
        'JOIN produto p ON c.id_produto = p.id';

        Open;
      end;

      while not uDataModule.qryCarrinho.Eof do
      begin
        with uDataModule.qryVendaEfetuadaInsert do
        begin
          SQL.Text :=
            'INSERT INTO venda_efetuada (id_produto, quantidade, valor_total_compra, cpf_cliente) ' +
            'VALUES (:idProduto, :quantidade, :valorTotalCompra, :cpfCliente)';

          Parameters.ParamByName('idProduto').Value :=
            uDataModule.qryCarrinho.FieldByName('id_produto').AsInteger;
          Parameters.ParamByName('quantidade').Value :=
            uDataModule.qryCarrinho.FieldByName('quantidade').AsInteger;
          Parameters.ParamByName('valorTotalCompra').Value :=
            uDataModule.qryCarrinho.FieldByName('preco_total').AsFloat;
          Parameters.ParamByName('cpfCliente').Value := cpfCliente;

          ExecSQL;
        end;

  uDataModule.qryCarrinho.Next;
end;

     ShowMessage('Compra efetuada com sucesso!');


  finally
    cCliente.Free;
  end;
end;


end.

